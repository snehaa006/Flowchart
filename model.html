<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IIoT Press Machine Monitoring System</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      overflow: hidden;
      background: #1a1a2e;
    }
    #container { width: 100vw; height: 100vh; position: relative; }
    canvas { display: block; cursor: grab; }
    canvas:active { cursor: grabbing; }

    /* Component Labels */
    .component-label {
      position: absolute;
      background: rgba(0, 0, 0, 0.85);
      color: #00e5ff;
      padding: 8px 14px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      pointer-events: none;
      z-index: 50;
      border: 1px solid rgba(0, 229, 255, 0.3);
      white-space: nowrap;
      transform: translate(-50%, -100%);
      margin-top: -10px;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .component-label.visible { opacity: 1; }
    .component-label::after {
      content: '';
      position: absolute;
      bottom: -6px;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: rgba(0, 0, 0, 0.85);
    }

    /* Info tooltip */
    .info-bar {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(20, 20, 35, 0.95);
      color: #fff;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 13px;
      z-index: 100;
      border: 1px solid rgba(0, 229, 255, 0.2);
    }
    .info-bar span { color: #00e5ff; font-weight: 600; }

    /* Control buttons */
    .controls {
      position: absolute;
      top: 20px;
      right: 20px;
      display: flex;
      gap: 10px;
      z-index: 100;
    }
    .ctrl-btn {
      width: 44px;
      height: 44px;
      border-radius: 8px;
      background: rgba(30, 30, 50, 0.9);
      border: 1px solid rgba(100, 100, 150, 0.3);
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      transition: all 0.2s;
    }
    .ctrl-btn:hover {
      background: rgba(50, 50, 80, 0.95);
      border-color: #00e5ff;
    }

    /* Legend */
    .legend {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: rgba(20, 20, 35, 0.95);
      border-radius: 10px;
      padding: 15px 20px;
      color: white;
      font-size: 12px;
      z-index: 100;
      border: 1px solid rgba(100, 100, 150, 0.3);
    }
    .legend h4 {
      font-size: 11px;
      color: #888;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }
    .legend-item:last-child { margin-bottom: 0; }
    .legend-color {
      width: 20px;
      height: 4px;
      border-radius: 2px;
    }
    .legend-color.cyan { background: #00e5ff; box-shadow: 0 0 8px #00e5ff; }
    .legend-color.orange { background: #ffa726; box-shadow: 0 0 8px #ffa726; }

    /* Data flow label */
    .flow-label {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: rgba(20, 20, 35, 0.95);
      border-radius: 10px;
      padding: 15px 20px;
      color: white;
      font-size: 11px;
      z-index: 100;
      border: 1px solid rgba(100, 100, 150, 0.3);
      text-align: center;
    }
    .flow-label .flow-path {
      color: #00e5ff;
      font-weight: 600;
      font-size: 10px;
      letter-spacing: 0.5px;
    }

    /* Overlay */
    .overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.6);
      z-index: 150;
      animation: fadeIn 0.2s;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* Info Panel */
    .info-panel {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 420px;
      max-height: 85vh;
      background: rgba(25, 25, 40, 0.98);
      border-radius: 16px;
      box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
      z-index: 200;
      animation: popupIn 0.25s ease-out;
      overflow: hidden;
      border: 1px solid rgba(100, 150, 255, 0.2);
    }
    @keyframes popupIn {
      from { opacity: 0; transform: translate(-50%, -50%) scale(0.95); }
      to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    }
    .panel-header {
      padding: 20px 24px;
      background: linear-gradient(135deg, #1e3a5f, #2d5a87);
      color: white;
      display: flex;
      align-items: center;
      gap: 14px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .panel-icon {
      width: 50px;
      height: 50px;
      background: rgba(255, 255, 255, 0.15);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }
    .panel-title h3 { margin: 0; font-size: 17px; font-weight: 600; }
    .panel-title .subtitle { font-size: 12px; opacity: 0.7; margin-top: 3px; }
    .panel-close {
      margin-left: auto;
      width: 32px; height: 32px;
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: white;
      cursor: pointer;
      font-size: 18px;
    }
    .panel-close:hover { background: rgba(255, 255, 255, 0.2); }
    .panel-content {
      padding: 20px 24px;
      max-height: 55vh;
      overflow-y: auto;
      color: #ddd;
    }
    .status-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 15px;
    }
    .status-indicator {
      width: 10px; height: 10px;
      border-radius: 50%;
      animation: blink 1.5s infinite;
    }
    .status-indicator.green { background: #00e676; box-shadow: 0 0 10px #00e676; }
    .status-indicator.yellow { background: #ffeb3b; box-shadow: 0 0 10px #ffeb3b; }
    .status-indicator.red { background: #ff5252; box-shadow: 0 0 10px #ff5252; }
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .status-text { font-size: 13px; font-weight: 600; }
    .data-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 15px;
    }
    .data-card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      padding: 14px;
      border: 1px solid rgba(255, 255, 255, 0.08);
    }
    .data-card .label {
      font-size: 10px;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
    }
    .data-card .value {
      font-size: 20px;
      font-weight: 700;
      color: #00e5ff;
      font-family: 'SF Mono', Monaco, monospace;
    }
    .data-card .unit {
      font-size: 11px;
      color: #666;
      margin-left: 3px;
    }
    .data-list {
      margin-top: 15px;
    }
    .data-list-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 12px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 8px;
      margin-bottom: 6px;
      border-left: 3px solid #00e5ff;
    }
    .data-list-item .label { font-size: 12px; color: #aaa; }
    .data-list-item .value { font-size: 13px; font-weight: 600; color: #fff; }
    .section-title {
      font-size: 11px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin: 20px 0 10px 0;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .tree-view {
      font-size: 12px;
      color: #bbb;
      margin-top: 10px;
    }
    .tree-node {
      padding: 6px 0 6px 20px;
      border-left: 1px dashed rgba(0, 229, 255, 0.3);
      margin-left: 10px;
    }
    .tree-node::before {
      content: '‚îú‚îÄ ';
      color: #00e5ff;
    }
    .tree-root {
      color: #00e5ff;
      font-weight: 600;
    }
    /* Portal Selection */
    .portal-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 15px;
    }
    .portal-card {
      background: linear-gradient(135deg, rgba(0, 229, 255, 0.1), rgba(100, 100, 255, 0.05));
      border: 1px solid rgba(0, 229, 255, 0.2);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    .portal-card:hover {
      background: linear-gradient(135deg, rgba(0, 229, 255, 0.2), rgba(100, 100, 255, 0.1));
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 229, 255, 0.2);
    }
    .portal-card .icon { font-size: 32px; margin-bottom: 10px; }
    .portal-card .name { font-size: 13px; font-weight: 600; color: #fff; }
    .portal-card .desc { font-size: 10px; color: #888; margin-top: 5px; }
    /* Charts in popup */
    .mini-chart {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      padding: 12px;
      margin-top: 10px;
    }
    .chart-bars {
      display: flex;
      align-items: flex-end;
      justify-content: space-around;
      height: 60px;
      gap: 6px;
    }
    .chart-bar {
      width: 20px;
      background: linear-gradient(to top, #00e5ff, #0099cc);
      border-radius: 3px 3px 0 0;
      animation: barGrow 0.6s ease-out;
    }
    @keyframes barGrow { from { transform: scaleY(0); } to { transform: scaleY(1); } }
    .chart-labels {
      display: flex;
      justify-content: space-around;
      margin-top: 8px;
      font-size: 9px;
      color: #666;
    }
  </style>
</head>
<body>
  <div id="container"></div>

  <!-- Info Bar -->
  <div class="info-bar">
    <span>IIoT Press Machine Monitoring</span> ‚Äî Click components to inspect | Drag to rotate
  </div>

  <!-- Controls -->
  <div class="controls">
    <button class="ctrl-btn" onclick="resetView()" title="Reset View">‚Ü∫</button>
    <button class="ctrl-btn" onclick="toggleLabels()" title="Toggle Labels">üè∑</button>
  </div>

  <!-- Legend -->
  <div class="legend">
    <h4>Data Flow</h4>
    <div class="legend-item">
      <div class="legend-color cyan"></div>
      <span>Sensor Data (Cyan)</span>
    </div>
    <div class="legend-item">
      <div class="legend-color orange"></div>
      <span>Network Data (Orange)</span>
    </div>
  </div>

  <!-- Flow Path -->
  <div class="flow-label">
    <div style="margin-bottom: 8px; color: #888;">System Architecture</div>
    <div class="flow-path">PRESS ‚Üí SENSORS ‚Üí PLC ‚Üí EDGE ‚Üí CLOUD ‚Üí DASHBOARD</div>
  </div>

  <!-- Component Labels Container -->
  <div id="labelsContainer"></div>

  <!-- Overlay & Panel -->
  <div id="overlay" class="overlay" style="display: none;" onclick="hidePanel()"></div>
  <div id="infoPanel" class="info-panel" style="display: none;"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script>
    // ============================================
    // SCENE SETUP
    // ============================================
    const container = document.getElementById('container');
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x1a1a2e);

    const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(30, 18, 30);
    camera.lookAt(8, 0, 0);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;
    container.appendChild(renderer.domElement);

    // Lighting
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
    scene.add(ambientLight);

    const mainLight = new THREE.DirectionalLight(0xffffff, 0.8);
    mainLight.position.set(20, 30, 20);
    mainLight.castShadow = true;
    mainLight.shadow.mapSize.width = 2048;
    mainLight.shadow.mapSize.height = 2048;
    mainLight.shadow.camera.near = 0.5;
    mainLight.shadow.camera.far = 100;
    mainLight.shadow.camera.left = -40;
    mainLight.shadow.camera.right = 40;
    mainLight.shadow.camera.top = 40;
    mainLight.shadow.camera.bottom = -40;
    scene.add(mainLight);

    const fillLight = new THREE.DirectionalLight(0x4488ff, 0.3);
    fillLight.position.set(-15, 10, -15);
    scene.add(fillLight);

    // Floor
    const floorGeo = new THREE.PlaneGeometry(80, 50);
    const floorMat = new THREE.MeshStandardMaterial({ color: 0x2a2a3e, roughness: 0.9 });
    const floor = new THREE.Mesh(floorGeo, floorMat);
    floor.rotation.x = -Math.PI / 2;
    floor.receiveShadow = true;
    scene.add(floor);

    // Grid lines on floor
    const gridHelper = new THREE.GridHelper(80, 40, 0x3a3a4e, 0x3a3a4e);
    gridHelper.position.y = 0.01;
    scene.add(gridHelper);

    // ============================================
    // MATERIALS
    // ============================================
    const metalGray = new THREE.MeshStandardMaterial({ color: 0x555566, metalness: 0.7, roughness: 0.3 });
    const metalDark = new THREE.MeshStandardMaterial({ color: 0x333340, metalness: 0.8, roughness: 0.2 });
    const metalLight = new THREE.MeshStandardMaterial({ color: 0x888899, metalness: 0.5, roughness: 0.4 });
    const yellowSafety = new THREE.MeshStandardMaterial({ color: 0xf5a623, metalness: 0.3, roughness: 0.5 });
    const redAccent = new THREE.MeshStandardMaterial({ color: 0xcc3333, metalness: 0.4, roughness: 0.4 });
    const greenLED = new THREE.MeshBasicMaterial({ color: 0x00ff88 });
    const cyanGlow = new THREE.MeshBasicMaterial({ color: 0x00e5ff });
    const orangeGlow = new THREE.MeshBasicMaterial({ color: 0xffa726 });
    const glassMat = new THREE.MeshStandardMaterial({
      color: 0x88ccff,
      transparent: true,
      opacity: 0.2,
      metalness: 0.1,
      roughness: 0.1
    });

    // ============================================
    // OBJECTS & LABELS
    // ============================================
    const objectsMap = {};
    const componentLabels = {};
    let labelsVisible = true;
    let pressRam; // For animation

    // ============================================
    // 1. INDUSTRIAL PRESS MACHINE
    // ============================================
    function createPressMachine() {
      const group = new THREE.Group();

      // Base plate
      const basePlate = new THREE.Mesh(new THREE.BoxGeometry(5, 0.4, 4), metalDark);
      basePlate.position.y = 0.2;
      basePlate.castShadow = true;
      basePlate.receiveShadow = true;
      group.add(basePlate);

      // Left column
      const columnGeo = new THREE.BoxGeometry(0.6, 7, 0.6);
      const leftColumn = new THREE.Mesh(columnGeo, metalGray);
      leftColumn.position.set(-2, 3.7, 0);
      leftColumn.castShadow = true;
      group.add(leftColumn);

      // Right column
      const rightColumn = new THREE.Mesh(columnGeo, metalGray);
      rightColumn.position.set(2, 3.7, 0);
      rightColumn.castShadow = true;
      group.add(rightColumn);

      // Top beam (crown)
      const topBeam = new THREE.Mesh(new THREE.BoxGeometry(5.2, 0.8, 1.2), metalGray);
      topBeam.position.set(0, 7.5, 0);
      topBeam.castShadow = true;
      group.add(topBeam);

      // Hydraulic cylinder housing
      const cylinderHousing = new THREE.Mesh(new THREE.CylinderGeometry(0.5, 0.5, 1.5, 32), metalDark);
      cylinderHousing.position.set(0, 6.5, 0);
      group.add(cylinderHousing);

      // RAM (moving part) - will be animated
      const ramGroup = new THREE.Group();

      const ramHead = new THREE.Mesh(new THREE.BoxGeometry(3.5, 0.6, 2.5), metalLight);
      ramHead.position.y = 0;
      ramHead.castShadow = true;
      ramGroup.add(ramHead);

      const ramPiston = new THREE.Mesh(new THREE.CylinderGeometry(0.35, 0.35, 1.5, 32), metalGray);
      ramPiston.position.y = 1.05;
      ramGroup.add(ramPiston);

      // Yellow safety stripe on ram
      const safetyStripe = new THREE.Mesh(new THREE.BoxGeometry(3.6, 0.1, 2.6), yellowSafety);
      safetyStripe.position.y = 0.35;
      ramGroup.add(safetyStripe);

      ramGroup.position.set(0, 5, 0);
      group.add(ramGroup);
      pressRam = ramGroup;

      // Die/Table (bottom)
      const dieTable = new THREE.Mesh(new THREE.BoxGeometry(3.5, 0.5, 2.5), metalLight);
      dieTable.position.set(0, 0.65, 0);
      dieTable.castShadow = true;
      group.add(dieTable);

      // Die insert
      const dieInsert = new THREE.Mesh(new THREE.BoxGeometry(2.5, 0.3, 1.8), metalDark);
      dieInsert.position.set(0, 1.05, 0);
      group.add(dieInsert);

      // Motor housing (back)
      const motorHousing = new THREE.Mesh(new THREE.BoxGeometry(1.5, 2, 1.5), metalDark);
      motorHousing.position.set(0, 1.5, -2.5);
      motorHousing.castShadow = true;
      group.add(motorHousing);

      // Control buttons box
      const buttonBox = new THREE.Mesh(new THREE.BoxGeometry(0.8, 0.5, 0.3), metalGray);
      buttonBox.position.set(2.8, 3, 1);
      group.add(buttonBox);

      // Start button (green)
      const startBtn = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.1, 0.1, 16), greenLED);
      startBtn.rotation.x = Math.PI / 2;
      startBtn.position.set(2.8, 3.1, 1.2);
      group.add(startBtn);

      // Stop button (red)
      const stopBtn = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.1, 0.1, 16), redAccent);
      stopBtn.rotation.x = Math.PI / 2;
      stopBtn.position.set(2.8, 2.9, 1.2);
      group.add(stopBtn);

      return group;
    }

    // ============================================
    // 2. SENSORS (Attached to Machine)
    // ============================================
    function createProximitySensor() {
      const group = new THREE.Group();

      // Sensor body (cylindrical)
      const body = new THREE.Mesh(new THREE.CylinderGeometry(0.15, 0.15, 0.5, 16), metalDark);
      body.rotation.x = Math.PI / 2;
      group.add(body);

      // Sensing face (cyan glow)
      const face = new THREE.Mesh(new THREE.CylinderGeometry(0.12, 0.12, 0.05, 16),
        new THREE.MeshBasicMaterial({ color: 0x00e5ff, transparent: true, opacity: 0.8 }));
      face.rotation.x = Math.PI / 2;
      face.position.z = 0.27;
      group.add(face);

      // Mounting bracket
      const bracket = new THREE.Mesh(new THREE.BoxGeometry(0.3, 0.4, 0.1), metalGray);
      bracket.position.z = -0.3;
      group.add(bracket);

      // Cable
      const cableGeo = new THREE.CylinderGeometry(0.03, 0.03, 0.8, 8);
      const cable = new THREE.Mesh(cableGeo, new THREE.MeshStandardMaterial({ color: 0x222222 }));
      cable.position.set(0, -0.4, -0.25);
      group.add(cable);

      return group;
    }

    function createTemperatureSensor() {
      const group = new THREE.Group();

      // Sensor body (box type)
      const body = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.25, 0.2), metalDark);
      group.add(body);

      // Display window
      const display = new THREE.Mesh(new THREE.BoxGeometry(0.25, 0.12, 0.02),
        new THREE.MeshBasicMaterial({ color: 0xff6600 }));
      display.position.z = 0.11;
      group.add(display);

      // Probe
      const probe = new THREE.Mesh(new THREE.CylinderGeometry(0.03, 0.03, 0.4, 8), metalGray);
      probe.rotation.z = Math.PI / 2;
      probe.position.x = 0.4;
      group.add(probe);

      // Mounting plate
      const mount = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.35, 0.05), metalGray);
      mount.position.z = -0.12;
      group.add(mount);

      return group;
    }

    function createVibrationSensor() {
      const group = new THREE.Group();

      // Sensor body (small cube)
      const body = new THREE.Mesh(new THREE.BoxGeometry(0.35, 0.35, 0.35), metalDark);
      group.add(body);

      // Top indicator
      const indicator = new THREE.Mesh(new THREE.CylinderGeometry(0.08, 0.08, 0.05, 16),
        new THREE.MeshBasicMaterial({ color: 0x00ff88 }));
      indicator.position.y = 0.2;
      group.add(indicator);

      // Mounting stud
      const stud = new THREE.Mesh(new THREE.CylinderGeometry(0.06, 0.06, 0.2, 8), metalGray);
      stud.position.y = -0.27;
      group.add(stud);

      // Cable connector
      const connector = new THREE.Mesh(new THREE.CylinderGeometry(0.05, 0.05, 0.15, 8),
        new THREE.MeshStandardMaterial({ color: 0x222222 }));
      connector.rotation.x = Math.PI / 2;
      connector.position.z = 0.25;
      group.add(connector);

      return group;
    }

    // ============================================
    // 3. PLC CONTROL CABINET
    // ============================================
    function createPLCCabinet() {
      const group = new THREE.Group();

      // Main cabinet body
      const cabinet = new THREE.Mesh(new THREE.BoxGeometry(1.8, 4, 1.2), metalGray);
      cabinet.position.y = 2;
      cabinet.castShadow = true;
      group.add(cabinet);

      // Cabinet door frame
      const doorFrame = new THREE.Mesh(new THREE.BoxGeometry(1.5, 3.5, 0.05), metalLight);
      doorFrame.position.set(0, 2, 0.63);
      group.add(doorFrame);

      // HMI Screen
      const screenBorder = new THREE.Mesh(new THREE.BoxGeometry(1, 0.8, 0.08), metalDark);
      screenBorder.position.set(0, 3.2, 0.68);
      group.add(screenBorder);

      const screen = new THREE.Mesh(new THREE.BoxGeometry(0.85, 0.65, 0.02),
        new THREE.MeshBasicMaterial({ color: 0x1a3a5c }));
      screen.position.set(0, 3.2, 0.74);
      group.add(screen);

      // Screen content glow
      const screenGlow = new THREE.Mesh(new THREE.BoxGeometry(0.75, 0.55, 0.01),
        new THREE.MeshBasicMaterial({ color: 0x00e5ff, transparent: true, opacity: 0.3 }));
      screenGlow.position.set(0, 3.2, 0.75);
      group.add(screenGlow);

      // Status LEDs
      const ledColors = [0x00ff88, 0x00ff88, 0xffaa00, 0xff4444];
      for (let i = 0; i < 4; i++) {
        const led = new THREE.Mesh(new THREE.SphereGeometry(0.05, 8, 8),
          new THREE.MeshBasicMaterial({ color: ledColors[i] }));
        led.position.set(-0.5 + i * 0.33, 2.5, 0.68);
        group.add(led);
      }

      // Ventilation slots
      for (let i = 0; i < 5; i++) {
        const slot = new THREE.Mesh(new THREE.BoxGeometry(0.8, 0.05, 0.02), metalDark);
        slot.position.set(0, 0.8 + i * 0.15, 0.62);
        group.add(slot);
      }

      // Cable entry (bottom)
      const cableEntry = new THREE.Mesh(new THREE.BoxGeometry(0.8, 0.3, 0.3), metalDark);
      cableEntry.position.set(0, 0.15, 0);
      group.add(cableEntry);

      // "PLC" label
      const labelGeo = new THREE.BoxGeometry(0.6, 0.2, 0.01);
      const labelMat = new THREE.MeshBasicMaterial({ color: 0x00e5ff });
      const label = new THREE.Mesh(labelGeo, labelMat);
      label.position.set(0, 3.7, 0.68);
      group.add(label);

      return group;
    }

    // ============================================
    // 4. EDGE GATEWAY
    // ============================================
    function createEdgeGateway() {
      const group = new THREE.Group();

      // Gateway box
      const box = new THREE.Mesh(new THREE.BoxGeometry(1.2, 0.8, 1), metalDark);
      box.position.y = 0.4;
      box.castShadow = true;
      group.add(box);

      // Front panel
      const panel = new THREE.Mesh(new THREE.BoxGeometry(1.1, 0.7, 0.02), metalGray);
      panel.position.set(0, 0.4, 0.52);
      group.add(panel);

      // Status LEDs
      for (let i = 0; i < 3; i++) {
        const led = new THREE.Mesh(new THREE.SphereGeometry(0.04, 8, 8),
          new THREE.MeshBasicMaterial({ color: i === 0 ? 0x00ff88 : 0x00e5ff }));
        led.position.set(-0.3 + i * 0.3, 0.6, 0.54);
        group.add(led);
      }

      // Ethernet ports
      for (let i = 0; i < 2; i++) {
        const port = new THREE.Mesh(new THREE.BoxGeometry(0.2, 0.15, 0.05), metalDark);
        port.position.set(-0.25 + i * 0.5, 0.25, 0.53);
        group.add(port);
      }

      // Antenna
      const antenna = new THREE.Mesh(new THREE.CylinderGeometry(0.02, 0.02, 0.6, 8), metalGray);
      antenna.position.set(0.4, 1, 0);
      group.add(antenna);

      const antennaTop = new THREE.Mesh(new THREE.SphereGeometry(0.05, 8, 8), metalDark);
      antennaTop.position.set(0.4, 1.3, 0);
      group.add(antennaTop);

      // Mounting bracket
      const bracket = new THREE.Mesh(new THREE.BoxGeometry(1.4, 0.1, 1.2), metalGray);
      bracket.position.y = 0;
      group.add(bracket);

      return group;
    }

    // ============================================
    // 5. CLOUD PLATFORM
    // ============================================
    function createCloudPlatform() {
      const group = new THREE.Group();

      // Server rack base
      const rackBase = new THREE.Mesh(new THREE.BoxGeometry(2, 0.2, 1.5), metalDark);
      rackBase.position.y = 0.1;
      rackBase.castShadow = true;
      group.add(rackBase);

      // Server units (stacked)
      for (let i = 0; i < 3; i++) {
        const server = new THREE.Mesh(new THREE.BoxGeometry(1.8, 0.5, 1.3), metalGray);
        server.position.set(0, 0.55 + i * 0.6, 0);
        server.castShadow = true;
        group.add(server);

        // Server LEDs
        for (let j = 0; j < 4; j++) {
          const led = new THREE.Mesh(new THREE.SphereGeometry(0.03, 8, 8),
            new THREE.MeshBasicMaterial({ color: Math.random() > 0.3 ? 0x00ff88 : 0x00e5ff }));
          led.position.set(-0.6 + j * 0.4, 0.55 + i * 0.6, 0.66);
          group.add(led);
        }
      }

      // Cloud symbol (floating above)
      const cloudMat = new THREE.MeshStandardMaterial({
        color: 0xffffff,
        transparent: true,
        opacity: 0.6,
        emissive: 0x4488ff,
        emissiveIntensity: 0.3
      });

      const cloudParts = [
        { pos: [0, 3.5, 0], scale: 0.5 },
        { pos: [0.4, 3.5, 0], scale: 0.4 },
        { pos: [-0.35, 3.5, 0], scale: 0.35 },
        { pos: [0.15, 3.7, 0], scale: 0.35 }
      ];

      cloudParts.forEach(part => {
        const sphere = new THREE.Mesh(new THREE.SphereGeometry(part.scale, 16, 16), cloudMat);
        sphere.position.set(...part.pos);
        group.add(sphere);
      });

      return group;
    }

    // ============================================
    // 6. DASHBOARD SCREENS
    // ============================================
    function createDashboardScreens() {
      const group = new THREE.Group();

      // Main screen stand
      const standBase = new THREE.Mesh(new THREE.BoxGeometry(0.8, 0.15, 0.8), metalDark);
      standBase.position.y = 0.075;
      standBase.castShadow = true;
      group.add(standBase);

      const standPole = new THREE.Mesh(new THREE.CylinderGeometry(0.08, 0.1, 2, 16), metalGray);
      standPole.position.y = 1.15;
      group.add(standPole);

      // Main dashboard screen
      const screenFrame = new THREE.Mesh(new THREE.BoxGeometry(3, 2, 0.1), metalDark);
      screenFrame.position.set(0, 3, 0);
      screenFrame.castShadow = true;
      group.add(screenFrame);

      const screenGlass = new THREE.Mesh(new THREE.BoxGeometry(2.8, 1.8, 0.05), glassMat);
      screenGlass.position.set(0, 3, 0.08);
      group.add(screenGlass);

      // Screen frame glow
      const frameGlow = new THREE.LineSegments(
        new THREE.EdgesGeometry(new THREE.BoxGeometry(2.85, 1.85, 0.02)),
        new THREE.LineBasicMaterial({ color: 0x00e5ff, transparent: true, opacity: 0.7 })
      );
      frameGlow.position.set(0, 3, 0.08);
      group.add(frameGlow);

      // Dashboard content (simplified charts)
      // Bar chart
      const barHeights = [0.4, 0.6, 0.5, 0.8, 0.65];
      barHeights.forEach((h, i) => {
        const bar = new THREE.Mesh(
          new THREE.BoxGeometry(0.15, h, 0.02),
          new THREE.MeshBasicMaterial({ color: 0x00e5ff })
        );
        bar.position.set(-0.8 + i * 0.25, 2.4 + h / 2, 0.1);
        group.add(bar);
      });

      // Pie chart (simplified)
      const pieGeo = new THREE.CircleGeometry(0.35, 32);
      const pie = new THREE.Mesh(pieGeo, new THREE.MeshBasicMaterial({ color: 0x00e5ff }));
      pie.position.set(0.8, 3.3, 0.1);
      group.add(pie);

      const pieSegment = new THREE.Mesh(
        new THREE.CircleGeometry(0.35, 32, 0, Math.PI * 0.7),
        new THREE.MeshBasicMaterial({ color: 0xffa726 })
      );
      pieSegment.position.set(0.8, 3.3, 0.11);
      group.add(pieSegment);

      // Secondary screen (angled)
      const screen2Frame = new THREE.Mesh(new THREE.BoxGeometry(2, 1.5, 0.08), metalDark);
      screen2Frame.position.set(2.2, 2.8, 0.8);
      screen2Frame.rotation.y = -0.4;
      group.add(screen2Frame);

      const screen2Glass = new THREE.Mesh(new THREE.BoxGeometry(1.85, 1.35, 0.03), glassMat);
      screen2Glass.position.set(2.2, 2.8, 0.85);
      screen2Glass.rotation.y = -0.4;
      group.add(screen2Glass);

      return group;
    }

    // ============================================
    // 7. RECTILINEAR DATA PIPELINES (90-degree)
    // ============================================
    function createPipeline(segments, color, radius = 0.06) {
      const pipes = [];
      const material = new THREE.MeshStandardMaterial({
        color: 0xffffff,
        metalness: 0.3,
        roughness: 0.4,
        transparent: true,
        opacity: 0.8
      });
      const glowMaterial = new THREE.MeshBasicMaterial({ color: color });

      segments.forEach(seg => {
        const start = new THREE.Vector3(...seg[0]);
        const end = new THREE.Vector3(...seg[1]);
        const direction = new THREE.Vector3().subVectors(end, start);
        const length = direction.length();

        // Outer pipe
        const pipeGeo = new THREE.CylinderGeometry(radius, radius, length, 8);
        const pipe = new THREE.Mesh(pipeGeo, material);

        // Position and rotate
        pipe.position.copy(start).add(direction.multiplyScalar(0.5));
        pipe.quaternion.setFromUnitVectors(
          new THREE.Vector3(0, 1, 0),
          direction.clone().normalize()
        );

        scene.add(pipe);
        pipes.push({ mesh: pipe, start: seg[0], end: seg[1], color });

        // Inner glow line
        const innerGeo = new THREE.CylinderGeometry(radius * 0.4, radius * 0.4, length, 8);
        const innerPipe = new THREE.Mesh(innerGeo, glowMaterial);
        innerPipe.position.copy(pipe.position);
        innerPipe.quaternion.copy(pipe.quaternion);
        scene.add(innerPipe);
      });

      return pipes;
    }

    function createCorner(position, color, radius = 0.06) {
      const cornerGeo = new THREE.SphereGeometry(radius * 1.2, 8, 8);
      const corner = new THREE.Mesh(cornerGeo, new THREE.MeshBasicMaterial({ color }));
      corner.position.set(...position);
      scene.add(corner);
    }

    // ============================================
    // BUILD THE SCENE
    // ============================================

    // Position X values for left-to-right layout
    const POS = {
      press: -8,
      plc: 0,
      edge: 8,
      cloud: 16,
      dashboard: 24
    };

    // 1. Press Machine
    const pressMachine = createPressMachine();
    pressMachine.position.set(POS.press, 0, 0);
    pressMachine.userData = { type: 'press', label: 'Press Machine' };
    scene.add(pressMachine);
    objectsMap.press = pressMachine;
    componentLabels.press = { obj: pressMachine, text: 'HYDRAULIC PRESS\n200-Ton Capacity', offset: [0, 9, 0] };

    // 2. Sensors (attached to press)
    const proxSensor = createProximitySensor();
    proxSensor.position.set(POS.press - 1.5, 5.5, 1.5);
    proxSensor.rotation.y = Math.PI / 4;
    proxSensor.userData = { type: 'proximity', label: 'Proximity Sensor' };
    scene.add(proxSensor);
    objectsMap.proximity = proxSensor;
    componentLabels.proximity = { obj: proxSensor, text: 'PROXIMITY SENSOR\nStroke Detection', offset: [0, 1, 0] };

    const tempSensor = createTemperatureSensor();
    tempSensor.position.set(POS.press, 2, -2.8);
    tempSensor.userData = { type: 'temperature', label: 'Temperature Sensor' };
    scene.add(tempSensor);
    objectsMap.temperature = tempSensor;
    componentLabels.temperature = { obj: tempSensor, text: 'TEMP SENSOR\nMotor Monitoring', offset: [0, 0.8, 0] };

    const vibSensor = createVibrationSensor();
    vibSensor.position.set(POS.press + 1.5, 0.6, 1.5);
    vibSensor.userData = { type: 'vibration', label: 'Vibration Sensor' };
    scene.add(vibSensor);
    objectsMap.vibration = vibSensor;
    componentLabels.vibration = { obj: vibSensor, text: 'VIBRATION SENSOR\nCondition Monitoring', offset: [0, 0.8, 0] };

    // 3. PLC Cabinet
    const plcCabinet = createPLCCabinet();
    plcCabinet.position.set(POS.plc, 0, 0);
    plcCabinet.userData = { type: 'plc', label: 'PLC Cabinet' };
    scene.add(plcCabinet);
    objectsMap.plc = plcCabinet;
    componentLabels.plc = { obj: plcCabinet, text: 'PLC CABINET\nSiemens S7-1200', offset: [0, 5, 0] };

    // 4. Edge Gateway
    const edgeGateway = createEdgeGateway();
    edgeGateway.position.set(POS.edge, 0, 0);
    edgeGateway.userData = { type: 'edge', label: 'Edge Gateway' };
    scene.add(edgeGateway);
    objectsMap.edge = edgeGateway;
    componentLabels.edge = { obj: edgeGateway, text: 'EDGE GATEWAY\nMQTT Protocol', offset: [0, 2, 0] };

    // 5. Cloud Platform
    const cloudPlatform = createCloudPlatform();
    cloudPlatform.position.set(POS.cloud, 0, 0);
    cloudPlatform.userData = { type: 'cloud', label: 'Cloud Platform' };
    scene.add(cloudPlatform);
    objectsMap.cloud = cloudPlatform;
    componentLabels.cloud = { obj: cloudPlatform, text: 'CLOUD PLATFORM\nAWS IoT + Database', offset: [0, 5, 0] };

    // 6. Dashboard Screens
    const dashboards = createDashboardScreens();
    dashboards.position.set(POS.dashboard, 0, 0);
    dashboards.userData = { type: 'dashboard', label: 'Dashboard' };
    scene.add(dashboards);
    objectsMap.dashboard = dashboards;
    componentLabels.dashboard = { obj: dashboards, text: 'MONITORING DASHBOARD\nReal-time Analytics', offset: [0, 5, 0] };

    // ============================================
    // DATA PIPELINES (Rectilinear 90-degree)
    // ============================================

    // Cyan pipes: Sensors ‚Üí PLC
    const cyanColor = 0x00e5ff;

    // Proximity sensor to PLC
    createPipeline([
      [[POS.press - 1.5, 5.5, 1.5], [POS.press - 1.5, 5.5, 3]],
      [[POS.press - 1.5, 5.5, 3], [POS.press - 1.5, 3, 3]],
      [[POS.press - 1.5, 3, 3], [POS.plc - 1, 3, 3]],
      [[POS.plc - 1, 3, 3], [POS.plc - 1, 3, 0.8]]
    ], cyanColor);
    createCorner([POS.press - 1.5, 5.5, 3], cyanColor);
    createCorner([POS.press - 1.5, 3, 3], cyanColor);
    createCorner([POS.plc - 1, 3, 3], cyanColor);

    // Temperature sensor to PLC
    createPipeline([
      [[POS.press, 2, -2.8], [POS.press, 2, -4]],
      [[POS.press, 2, -4], [POS.plc, 2, -4]],
      [[POS.plc, 2, -4], [POS.plc, 2, -0.8]]
    ], cyanColor);
    createCorner([POS.press, 2, -4], cyanColor);
    createCorner([POS.plc, 2, -4], cyanColor);

    // Vibration sensor to PLC
    createPipeline([
      [[POS.press + 1.5, 0.6, 1.5], [POS.press + 1.5, 0.6, 2.5]],
      [[POS.press + 1.5, 0.6, 2.5], [POS.plc + 1, 0.6, 2.5]],
      [[POS.plc + 1, 0.6, 2.5], [POS.plc + 1, 1, 0.8]]
    ], cyanColor);
    createCorner([POS.press + 1.5, 0.6, 2.5], cyanColor);
    createCorner([POS.plc + 1, 0.6, 2.5], cyanColor);

    // Orange pipes: PLC ‚Üí Edge ‚Üí Cloud ‚Üí Dashboard
    const orangeColor = 0xffa726;

    // PLC to Edge
    createPipeline([
      [[POS.plc + 1, 2.5, 0], [POS.plc + 2.5, 2.5, 0]],
      [[POS.plc + 2.5, 2.5, 0], [POS.plc + 2.5, 1.5, 0]],
      [[POS.plc + 2.5, 1.5, 0], [POS.edge - 0.8, 1.5, 0]],
      [[POS.edge - 0.8, 1.5, 0], [POS.edge - 0.8, 0.5, 0]]
    ], orangeColor);
    createCorner([POS.plc + 2.5, 2.5, 0], orangeColor);
    createCorner([POS.plc + 2.5, 1.5, 0], orangeColor);
    createCorner([POS.edge - 0.8, 1.5, 0], orangeColor);

    // Edge to Cloud
    createPipeline([
      [[POS.edge + 0.8, 0.5, 0], [POS.edge + 2, 0.5, 0]],
      [[POS.edge + 2, 0.5, 0], [POS.edge + 2, 2, 0]],
      [[POS.edge + 2, 2, 0], [POS.cloud - 1.2, 2, 0]]
    ], orangeColor);
    createCorner([POS.edge + 2, 0.5, 0], orangeColor);
    createCorner([POS.edge + 2, 2, 0], orangeColor);

    // Cloud to Dashboard
    createPipeline([
      [[POS.cloud + 1.2, 2, 0], [POS.cloud + 2.5, 2, 0]],
      [[POS.cloud + 2.5, 2, 0], [POS.cloud + 2.5, 3, 0]],
      [[POS.cloud + 2.5, 3, 0], [POS.dashboard - 1.8, 3, 0]]
    ], orangeColor);
    createCorner([POS.cloud + 2.5, 2, 0], orangeColor);
    createCorner([POS.cloud + 2.5, 3, 0], orangeColor);

    // ============================================
    // ANIMATED DATA PARTICLES
    // ============================================
    const particles = [];

    function createDataParticle(path, color, speed = 0.008) {
      const geo = new THREE.SphereGeometry(0.12, 8, 8);
      const mat = new THREE.MeshBasicMaterial({ color });
      const mesh = new THREE.Mesh(geo, mat);
      scene.add(mesh);

      return {
        mesh,
        path,
        pathIndex: 0,
        t: 0,
        speed,
        color
      };
    }

    // Create particles for each pipeline
    // Cyan particles (sensor data)
    const cyanPaths = [
      [[POS.press - 1.5, 5.5, 1.5], [POS.press - 1.5, 5.5, 3], [POS.press - 1.5, 3, 3], [POS.plc - 1, 3, 3], [POS.plc - 1, 3, 0.8]],
      [[POS.press, 2, -2.8], [POS.press, 2, -4], [POS.plc, 2, -4], [POS.plc, 2, -0.8]],
      [[POS.press + 1.5, 0.6, 1.5], [POS.press + 1.5, 0.6, 2.5], [POS.plc + 1, 0.6, 2.5], [POS.plc + 1, 1, 0.8]]
    ];

    cyanPaths.forEach(path => {
      for (let i = 0; i < 2; i++) {
        const p = createDataParticle(path, cyanColor, 0.015);
        p.t = i * 0.5;
        particles.push(p);
      }
    });

    // Orange particles (network data)
    const orangePath = [
      [POS.plc + 1, 2.5, 0], [POS.plc + 2.5, 2.5, 0], [POS.plc + 2.5, 1.5, 0],
      [POS.edge - 0.8, 1.5, 0], [POS.edge - 0.8, 0.5, 0], [POS.edge + 0.8, 0.5, 0],
      [POS.edge + 2, 0.5, 0], [POS.edge + 2, 2, 0], [POS.cloud - 1.2, 2, 0],
      [POS.cloud + 1.2, 2, 0], [POS.cloud + 2.5, 2, 0], [POS.cloud + 2.5, 3, 0],
      [POS.dashboard - 1.8, 3, 0]
    ];

    for (let i = 0; i < 4; i++) {
      const p = createDataParticle(orangePath, orangeColor, 0.012);
      p.t = i * 0.25;
      particles.push(p);
    }

    // ============================================
    // INFO PANEL DATA
    // ============================================
    const panelData = {
      press: {
        title: 'Press Machine',
        subtitle: 'Hydraulic Press - 200 Ton',
        icon: 'üè≠',
        content: `
          <div class="status-row">
            <div class="status-indicator green"></div>
            <span class="status-text">Machine Running</span>
          </div>
          <div class="data-grid">
            <div class="data-card">
              <div class="label">Stroke Rate</div>
              <div class="value">42<span class="unit">SPM</span></div>
            </div>
            <div class="data-card">
              <div class="label">Production</div>
              <div class="value">12,456<span class="unit">pcs</span></div>
            </div>
            <div class="data-card">
              <div class="label">Efficiency</div>
              <div class="value">94.2<span class="unit">%</span></div>
            </div>
            <div class="data-card">
              <div class="label">Cycle Time</div>
              <div class="value">1.43<span class="unit">sec</span></div>
            </div>
          </div>
          <div class="section-title">Production Trend (Last 6 Hours)</div>
          <div class="mini-chart">
            <div class="chart-bars">
              <div class="chart-bar" style="height: 40px;"></div>
              <div class="chart-bar" style="height: 55px;"></div>
              <div class="chart-bar" style="height: 48px;"></div>
              <div class="chart-bar" style="height: 52px;"></div>
              <div class="chart-bar" style="height: 45px;"></div>
              <div class="chart-bar" style="height: 58px;"></div>
            </div>
            <div class="chart-labels">
              <span>10AM</span><span>11AM</span><span>12PM</span><span>1PM</span><span>2PM</span><span>3PM</span>
            </div>
          </div>
        `
      },
      proximity: {
        title: 'Proximity Sensor',
        subtitle: 'Stroke Counter - Inductive',
        icon: 'üì°',
        content: `
          <div class="status-row">
            <div class="status-indicator green"></div>
            <span class="status-text">Sensor Active</span>
          </div>
          <div class="data-grid">
            <div class="data-card">
              <div class="label">Stroke Count</div>
              <div class="value">12,456</div>
            </div>
            <div class="data-card">
              <div class="label">Cycle Count</div>
              <div class="value">12,456</div>
            </div>
            <div class="data-card">
              <div class="label">Detection Range</div>
              <div class="value">8<span class="unit">mm</span></div>
            </div>
            <div class="data-card">
              <div class="label">Response Time</div>
              <div class="value">1<span class="unit">ms</span></div>
            </div>
          </div>
          <div class="data-list">
            <div class="data-list-item">
              <span class="label">Signal Quality</span>
              <span class="value">Excellent</span>
            </div>
            <div class="data-list-item">
              <span class="label">Output Type</span>
              <span class="value">PNP NO</span>
            </div>
          </div>
        `
      },
      temperature: {
        title: 'Temperature Sensor',
        subtitle: 'Motor Temperature Monitor',
        icon: 'üå°Ô∏è',
        content: `
          <div class="status-row">
            <div class="status-indicator green"></div>
            <span class="status-text">Normal Range</span>
          </div>
          <div class="data-grid">
            <div class="data-card">
              <div class="label">Motor Temp</div>
              <div class="value">45.2<span class="unit">¬∞C</span></div>
            </div>
            <div class="data-card">
              <div class="label">Ambient</div>
              <div class="value">28.5<span class="unit">¬∞C</span></div>
            </div>
          </div>
          <div class="data-list">
            <div class="data-list-item">
              <span class="label">Warning Level</span>
              <span class="value" style="color: #ffaa00;">65¬∞C</span>
            </div>
            <div class="data-list-item">
              <span class="label">Critical Level</span>
              <span class="value" style="color: #ff4444;">85¬∞C</span>
            </div>
            <div class="data-list-item">
              <span class="label">Status</span>
              <span class="value" style="color: #00ff88;">OK</span>
            </div>
          </div>
        `
      },
      vibration: {
        title: 'Vibration Sensor',
        subtitle: 'Condition Monitoring',
        icon: 'üìä',
        content: `
          <div class="status-row">
            <div class="status-indicator green"></div>
            <span class="status-text">Condition: Normal</span>
          </div>
          <div class="data-grid">
            <div class="data-card">
              <div class="label">RMS Vibration</div>
              <div class="value">2.4<span class="unit">mm/s</span></div>
            </div>
            <div class="data-card">
              <div class="label">Peak</div>
              <div class="value">4.8<span class="unit">mm/s</span></div>
            </div>
          </div>
          <div class="data-list">
            <div class="data-list-item">
              <span class="label">Frequency</span>
              <span class="value">42 Hz</span>
            </div>
            <div class="data-list-item">
              <span class="label">Health Score</span>
              <span class="value" style="color: #00ff88;">92%</span>
            </div>
            <div class="data-list-item">
              <span class="label">Alert Threshold</span>
              <span class="value">7.1 mm/s</span>
            </div>
          </div>
        `
      },
      plc: {
        title: 'PLC Cabinet',
        subtitle: 'Siemens S7-1200 Controller',
        icon: '‚öôÔ∏è',
        content: `
          <div class="status-row">
            <div class="status-indicator green"></div>
            <span class="status-text">RUN Mode</span>
          </div>
          <div class="section-title">Input Signals</div>
          <div class="data-list">
            <div class="data-list-item">
              <span class="label">I0.0 - Proximity</span>
              <span class="value" style="color: #00ff88;">HIGH</span>
            </div>
            <div class="data-list-item">
              <span class="label">I0.1 - Temperature</span>
              <span class="value">45.2¬∞C</span>
            </div>
            <div class="data-list-item">
              <span class="label">I0.2 - Vibration</span>
              <span class="value">2.4 mm/s</span>
            </div>
          </div>
          <div class="section-title">Output Status</div>
          <div class="data-list">
            <div class="data-list-item">
              <span class="label">Q0.0 - Motor</span>
              <span class="value" style="color: #00ff88;">ON</span>
            </div>
            <div class="data-list-item">
              <span class="label">Q0.1 - Valve</span>
              <span class="value" style="color: #00ff88;">OPEN</span>
            </div>
          </div>
          <div class="data-grid" style="margin-top: 15px;">
            <div class="data-card">
              <div class="label">Scan Time</div>
              <div class="value">8<span class="unit">ms</span></div>
            </div>
            <div class="data-card">
              <div class="label">CPU Load</div>
              <div class="value">34<span class="unit">%</span></div>
            </div>
          </div>
        `
      },
      edge: {
        title: 'Edge Gateway',
        subtitle: 'Industrial IoT Gateway',
        icon: 'üì°',
        content: `
          <div class="status-row">
            <div class="status-indicator green"></div>
            <span class="status-text">Connected</span>
          </div>
          <div class="data-list">
            <div class="data-list-item">
              <span class="label">Protocol</span>
              <span class="value">MQTT v3.1.1</span>
            </div>
            <div class="data-list-item">
              <span class="label">Broker</span>
              <span class="value">AWS IoT Core</span>
            </div>
            <div class="data-list-item">
              <span class="label">Data Buffering</span>
              <span class="value" style="color: #00ff88;">Enabled</span>
            </div>
            <div class="data-list-item">
              <span class="label">Encryption</span>
              <span class="value">TLS 1.3 üîí</span>
            </div>
          </div>
          <div class="data-grid" style="margin-top: 15px;">
            <div class="data-card">
              <div class="label">Messages/sec</div>
              <div class="value">125</div>
            </div>
            <div class="data-card">
              <div class="label">Latency</div>
              <div class="value">8<span class="unit">ms</span></div>
            </div>
          </div>
        `
      },
      cloud: {
        title: 'Cloud Platform',
        subtitle: 'AWS IoT + TimescaleDB',
        icon: '‚òÅÔ∏è',
        content: `
          <div class="status-row">
            <div class="status-indicator green"></div>
            <span class="status-text">Remote Monitoring Enabled</span>
          </div>
          <div class="section-title">Database Hierarchy</div>
          <div class="tree-view">
            <div class="tree-root">üìÅ Factory_01</div>
            <div class="tree-node">üìÅ Press_Line_A</div>
            <div class="tree-node" style="margin-left: 30px;">üìÅ Machine_01</div>
            <div class="tree-node" style="margin-left: 50px;">üìÑ Sensors</div>
            <div class="tree-node" style="margin-left: 50px;">üìÑ Production_Data</div>
            <div class="tree-node" style="margin-left: 50px;">üìÑ Maintenance_Log</div>
            <div class="tree-node" style="margin-left: 30px;">üìÅ Machine_02</div>
          </div>
          <div class="data-grid" style="margin-top: 15px;">
            <div class="data-card">
              <div class="label">Storage Used</div>
              <div class="value">2.4<span class="unit">TB</span></div>
            </div>
            <div class="data-card">
              <div class="label">Uptime</div>
              <div class="value">99.9<span class="unit">%</span></div>
            </div>
          </div>
        `
      },
      dashboard: {
        title: 'Dashboard Portals',
        subtitle: 'Real-time Monitoring & Analytics',
        icon: 'üìä',
        content: `
          <div class="status-row">
            <div class="status-indicator green"></div>
            <span class="status-text">3 Users Online</span>
          </div>
          <div class="section-title">Select Portal</div>
          <div class="portal-grid">
            <div class="portal-card" onclick="alert('Opening Press Portal...')">
              <div class="icon">üè≠</div>
              <div class="name">Press Portal</div>
              <div class="desc">Production & Efficiency</div>
            </div>
            <div class="portal-card" onclick="alert('Opening HR Portal...')">
              <div class="icon">üë•</div>
              <div class="name">HR Portal</div>
              <div class="desc">Attendance & Shifts</div>
            </div>
            <div class="portal-card" onclick="alert('Opening Maintenance Portal...')">
              <div class="icon">üîß</div>
              <div class="name">Maintenance</div>
              <div class="desc">Alerts & Schedules</div>
            </div>
            <div class="portal-card" onclick="alert('Opening Reports Portal...')">
              <div class="icon">üìã</div>
              <div class="name">Reports</div>
              <div class="desc">Analytics & Export</div>
            </div>
          </div>
        `
      }
    };

    // ============================================
    // SHOW INFO PANEL
    // ============================================
    function showInfoPanel(type) {
      const data = panelData[type];
      if (!data) return;

      document.getElementById('overlay').style.display = 'block';
      const panel = document.getElementById('infoPanel');
      panel.style.display = 'block';

      panel.innerHTML = `
        <div class="panel-header">
          <div class="panel-icon">${data.icon}</div>
          <div class="panel-title">
            <h3>${data.title}</h3>
            <div class="subtitle">${data.subtitle}</div>
          </div>
          <button class="panel-close" onclick="hidePanel()">√ó</button>
        </div>
        <div class="panel-content">
          ${data.content}
        </div>
      `;
    }

    function hidePanel() {
      document.getElementById('overlay').style.display = 'none';
      document.getElementById('infoPanel').style.display = 'none';
    }

    // ============================================
    // COMPONENT LABELS (Zoom-based)
    // ============================================
    function updateLabels() {
      const labelsContainer = document.getElementById('labelsContainer');
      labelsContainer.innerHTML = '';

      if (!labelsVisible) return;

      const cameraDistance = camera.position.length();
      const showLabels = cameraDistance < 45;

      Object.entries(componentLabels).forEach(([key, data]) => {
        const worldPos = new THREE.Vector3(...data.offset);
        data.obj.localToWorld(worldPos);

        const screenPos = worldPos.clone().project(camera);
        const x = (screenPos.x * 0.5 + 0.5) * window.innerWidth;
        const y = (-screenPos.y * 0.5 + 0.5) * window.innerHeight;

        if (screenPos.z < 1 && showLabels) {
          const label = document.createElement('div');
          label.className = 'component-label visible';
          label.innerHTML = data.text.replace('\n', '<br>');
          label.style.left = x + 'px';
          label.style.top = y + 'px';
          labelsContainer.appendChild(label);
        }
      });
    }

    function toggleLabels() {
      labelsVisible = !labelsVisible;
      updateLabels();
    }

    // ============================================
    // INTERACTION
    // ============================================
    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();
    let isDragging = false;
    let hasDragged = false;
    let previousMousePosition = { x: 0, y: 0 };
    let targetRotation = { x: 0.3, y: 0.5 };
    let currentRotation = { x: 0.3, y: 0.5 };

    renderer.domElement.addEventListener('mousedown', (e) => {
      isDragging = true;
      hasDragged = false;
      previousMousePosition = { x: e.clientX, y: e.clientY };
    });

    renderer.domElement.addEventListener('mousemove', (e) => {
      if (!isDragging) return;
      const deltaX = e.clientX - previousMousePosition.x;
      const deltaY = e.clientY - previousMousePosition.y;
      if (Math.abs(deltaX) > 3 || Math.abs(deltaY) > 3) hasDragged = true;
      targetRotation.y += deltaX * 0.005;
      targetRotation.x += deltaY * 0.003;
      targetRotation.x = Math.max(0.1, Math.min(0.6, targetRotation.x));
      previousMousePosition = { x: e.clientX, y: e.clientY };
    });

    renderer.domElement.addEventListener('mouseup', (e) => {
      if (!hasDragged) {
        const rect = renderer.domElement.getBoundingClientRect();
        mouse.x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
        mouse.y = -((e.clientY - rect.top) / rect.height) * 2 + 1;
        raycaster.setFromCamera(mouse, camera);
        const allObjects = Object.values(objectsMap);
        const intersects = raycaster.intersectObjects(allObjects, true);
        if (intersects.length > 0) {
          let obj = intersects[0].object;
          while (obj.parent && !obj.userData.type) {
            obj = obj.parent;
          }
          if (obj.userData.type) {
            showInfoPanel(obj.userData.type);
          }
        }
      }
      isDragging = false;
      hasDragged = false;
    });

    // Zoom with mouse wheel
    renderer.domElement.addEventListener('wheel', (e) => {
      e.preventDefault();
      const zoomSpeed = 0.001;
      const delta = e.deltaY * zoomSpeed;
      camera.position.multiplyScalar(1 + delta);
      camera.position.clampLength(15, 60);
    }, { passive: false });

    function resetView() {
      targetRotation = { x: 0.3, y: 0.5 };
    }

    // ============================================
    // ANIMATION
    // ============================================
    let animationFrame = 0;
    let ramDirection = 1;
    let ramPosition = 0;

    function animate() {
      requestAnimationFrame(animate);
      animationFrame++;

      // Smooth camera rotation
      currentRotation.x += (targetRotation.x - currentRotation.x) * 0.05;
      currentRotation.y += (targetRotation.y - currentRotation.y) * 0.05;

      const radius = camera.position.length();
      camera.position.x = radius * Math.sin(currentRotation.y) * Math.cos(currentRotation.x);
      camera.position.y = 8 + radius * Math.sin(currentRotation.x) * 0.5;
      camera.position.z = radius * Math.cos(currentRotation.y) * Math.cos(currentRotation.x);
      camera.lookAt(8, 2, 0);

      // Animate press ram (up/down)
      if (pressRam) {
        ramPosition += 0.02 * ramDirection;
        if (ramPosition > 1) { ramPosition = 1; ramDirection = -1; }
        if (ramPosition < 0) { ramPosition = 0; ramDirection = 1; }
        pressRam.position.y = 5 - ramPosition * 1.5;
      }

      // Animate particles along paths
      particles.forEach(p => {
        p.t += p.speed;
        if (p.t >= p.path.length - 1) p.t = 0;

        const idx = Math.floor(p.t);
        const frac = p.t - idx;
        const nextIdx = Math.min(idx + 1, p.path.length - 1);

        const start = new THREE.Vector3(...p.path[idx]);
        const end = new THREE.Vector3(...p.path[nextIdx]);
        p.mesh.position.lerpVectors(start, end, frac);
      });

      // Update labels
      updateLabels();

      renderer.render(scene, camera);
    }

    animate();

    // Resize
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>
</body>
</html>
